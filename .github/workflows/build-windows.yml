name: Build Windows Electron v18 App

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      build_version:
        description: "Build version (e.g., 18.0.0)"
        required: false
        default: ""

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag or input
        id: tag_version
        shell: pwsh
        run: |
          if ("${{ github.event.inputs.build_version }}" -ne "") {
            $version = "${{ github.event.inputs.build_version }}"
          } else {
            $version = "${{ github.ref }}".Replace("refs/tags/v", "")
          }
          echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "tag_version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "ğŸ—ï¸ Build version: $version" -ForegroundColor Green

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - name: Setup Python (for native modules)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup MSVC build environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Verify build tools
        shell: pwsh
        run: |
          Write-Host "âœ“ Python: $(python --version)" -ForegroundColor Green
          Write-Host "âœ“ Node: $(node -v)" -ForegroundColor Green
          Write-Host "âœ“ NPM: $(npm -v)" -ForegroundColor Green
          Write-Host "âœ“ MSVC: $(where cl.exe)" -ForegroundColor Green
          Write-Host "âœ“ Electron v18 target build" -ForegroundColor Cyan

      - name: Configure environment for desktop build
        shell: pwsh
        run: |
          @"
          PYTHON=$env:PythonLocation\python.exe
          GYP_MSVS_VERSION=2022
          npm_config_msvs_version=2022
          npm_config_build_from_source=true
          npm_config_python=$env:PythonLocation\python.exe
          BEYPRO_DESKTOP=1
          ELECTRON_CACHE=$pwd\.electron-cache
          ELECTRON_BUILDER_CACHE=$pwd\.builder-cache
          "@ | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Create cache directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path ".electron-cache" | Out-Null
          New-Item -ItemType Directory -Force -Path ".builder-cache" | Out-Null

      - name: Install npm dependencies
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Installing npm dependencies..." -ForegroundColor Cyan
          # Use npm install instead of ci to ensure optional deps are built
          npm install --legacy-peer-deps
          if ($LASTEXITCODE -ne 0) {
            Write-Host "âŒ npm install failed" -ForegroundColor Red
            exit 1
          }
          Write-Host "âœ“ Dependencies installed" -ForegroundColor Green
        env:
          PYTHON: ${{ env.PYTHON }}

      - name: Install Windows Rollup native module
        shell: pwsh
        run: |
          Write-Host "ğŸ”§ Installing @rollup/rollup-win32-x64-msvc..." -ForegroundColor Cyan
          npm install @rollup/rollup-win32-x64-msvc@4.50.2 --save-dev --force
          if ($LASTEXITCODE -ne 0) {
            Write-Host "âš ï¸ npm install of rollup module returned exit code $LASTEXITCODE (trying to continue)" -ForegroundColor Yellow
          }
          # Verify it exists
          if (Test-Path "node_modules/@rollup/rollup-win32-x64-msvc") {
            Write-Host "âœ“ Rollup native module installed" -ForegroundColor Green
          } else {
            Write-Host "âŒ Rollup native module not found after install!" -ForegroundColor Red
            exit 1
          }
        env:
          PYTHON: ${{ env.PYTHON }}

      - name: Install Electron builder dependencies
        run: npx electron-builder install-app-deps
        env:
          PYTHON: ${{ env.PYTHON }}

      - name: Install printer module for Electron
        run: |
          npm install @thesusheer/electron-printer@^2.0.4 --no-save --legacy-peer-deps
        env:
          PYTHON: ${{ env.PYTHON }}

      - name: Build React/Vite frontend
        shell: pwsh
        run: |
          Write-Host "ğŸ”¨ Building Vite frontend..." -ForegroundColor Cyan
          try {
            npm run build 2>&1
            if ($LASTEXITCODE -ne 0) {
              Write-Host "âŒ Vite build failed with exit code $LASTEXITCODE" -ForegroundColor Red
              exit 1
            }
            Write-Host "âœ“ Vite build successful" -ForegroundColor Green
          } catch {
            Write-Host "âŒ Exception: $_" -ForegroundColor Red
            exit 1
          }
        env:
          VITE_TARGET: electron
          VITE_API_URL: https://hurrypos-backend.onrender.com/api
          CI: true

      - name: Verify Vite build output
        shell: pwsh
        run: |
          Write-Host "ğŸ” Checking Vite build output..." -ForegroundColor Cyan
          if (Test-Path "dist") {
            Write-Host "âœ“ dist/ folder found" -ForegroundColor Green
            $files = Get-ChildItem dist -Recurse -File -ErrorAction SilentlyContinue
            $fileCount = ($files | Measure-Object).Count
            Write-Host "  Files: $fileCount" -ForegroundColor Yellow
            
            if ($fileCount -eq 0) {
              Write-Host "âš ï¸ WARNING: dist folder is empty!" -ForegroundColor Red
              exit 1
            }
            
            # Show first few files
            Write-Host "  Sample files:" -ForegroundColor Yellow
            Get-ChildItem dist -Recurse -File -ErrorAction SilentlyContinue | Select-Object -First 5 | ForEach-Object {
              Write-Host "    - $($_.Name)" -ForegroundColor Gray
            }
          } else {
            Write-Host "âœ— dist/ folder NOT found!" -ForegroundColor Red
            Write-Host "Current directory contents:" -ForegroundColor Yellow
            Get-ChildItem . | Where-Object { $_.Name -ne "node_modules" } | ForEach-Object {
              Write-Host "  - $($_.Name)" -ForegroundColor Gray
            }
            exit 1
          }

      - name: Build electron-builder installer
        shell: pwsh
        run: |
          Write-Host "ğŸ”¨ Running electron-builder..." -ForegroundColor Cyan
          Write-Host "Command: npx electron-builder --publish=never --win nsis" -ForegroundColor Gray
          Write-Host "Current directory: $(Get-Location)" -ForegroundColor Gray
          Write-Host "Python: $env:PYTHON" -ForegroundColor Gray
          Write-Host "" -ForegroundColor Gray

          # Run with output capture
          $output = npx electron-builder --publish=never --win nsis 2>&1
          $exitCode = $LASTEXITCODE

          # Write all output
          Write-Host $output -ForegroundColor Gray
          Write-Host "" -ForegroundColor Gray

          if ($exitCode -ne 0) {
            Write-Host "âŒ electron-builder failed with exit code $exitCode" -ForegroundColor Red
            Write-Host "Checking for ANY output files..." -ForegroundColor Yellow
            Get-ChildItem -Recurse -Include "*.exe", "*.yml", "*.blockmap" -Depth 10 -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  Found: $($_.FullName)" -ForegroundColor Yellow
            }
            exit 1
          }
          Write-Host "âœ“ electron-builder completed with exit code 0" -ForegroundColor Green
        env:
          PYTHON: ${{ env.PYTHON }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check electron-builder output directory
        shell: pwsh
        run: |
          Write-Host "ğŸ” Checking for build output..." -ForegroundColor Cyan
          $searchPaths = @("out", "dist", "release", "releases", ".")
          $found = $false
          $foundFiles = @()

          foreach ($path in $searchPaths) {
            if (Test-Path $path) {
              Write-Host "ğŸ“ Searching in: $path" -ForegroundColor Green
              $files = Get-ChildItem $path -Filter "*.exe" -ErrorAction SilentlyContinue -Depth 0
              if ($files) {
                Write-Host "  âœ“ Found $($files.Count) .exe files:" -ForegroundColor Green
                $files | ForEach-Object {
                  Write-Host "    - $($_.FullName)" -ForegroundColor Green
                  $foundFiles += $_.FullName
                }
                $found = $true
              }
            }
          }

          if (-not $found) {
            Write-Host "âš ï¸  No .exe files found in any standard directory" -ForegroundColor Yellow
            Write-Host "ğŸ“‹ All directories in workspace:" -ForegroundColor Yellow
            Get-ChildItem . -Directory -ErrorAction SilentlyContinue | Where-Object { $_.Name -ne "node_modules" } | ForEach-Object {
              Write-Host "  ğŸ“ $($_.Name)/" -ForegroundColor Gray
              Get-ChildItem $_.FullName -File -ErrorAction SilentlyContinue | Select-Object -First 5 | ForEach-Object {
                Write-Host "     - $($_.Name)" -ForegroundColor Gray
              }
            }
          } else {
            Write-Host ""
            Write-Host "âœ“ SUCCESS: Found $($foundFiles.Count) installer files" -ForegroundColor Green
          }

      - name: Consolidate build artifacts
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Consolidating artifacts..." -ForegroundColor Cyan

          # Check if out/ exists, if not create it
          if (-not (Test-Path "out")) {
            New-Item -ItemType Directory -Force -Path "out" | Out-Null
            Write-Host "Created out/ directory" -ForegroundColor Yellow
          }

          # Copy from alternative locations if needed
          $sources = @(
            @{ src = "dist/Beypro-POS-Setup-*.exe"; dest = "out/" },
            @{ src = "release/*.exe"; dest = "out/" },
            @{ src = "releases/*.exe"; dest = "out/" }
          )

          foreach ($source in $sources) {
            $files = Get-ChildItem $source.src -ErrorAction SilentlyContinue
            if ($files) {
              Write-Host "Found files in $($source.src), copying..." -ForegroundColor Yellow
              Copy-Item $source.src $source.dest -Force
            }
          }

          # List final artifacts
          if (Test-Path "out") {
            $exes = Get-ChildItem out -Filter "*.exe" -ErrorAction SilentlyContinue
            if ($exes) {
              Write-Host "âœ“ Final artifacts in out/:" -ForegroundColor Green
              $exes | ForEach-Object {
                $size = [Math]::Round($_.Length/1MB, 2)
                Write-Host "  - $($_.Name) ($size MB)" -ForegroundColor Green
              }
            }
          }

      - name: Create GitHub Release with GitHub CLI
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“ Creating release v${{ env.VERSION }}..."

          # Create release notes file to avoid YAML escaping issues
          cat > /tmp/release_notes.md << 'EOF'
          # Beypro POS v${{ env.VERSION }} - Windows Build

          **Release Information:**
          - **Electron Version:** 18.0.0
          - **Node.js:** ${{ matrix.node-version }}
          - **Platform:** Windows NSIS Installer

          **Key Features:**
          - âœ… Enhanced LAN printer detection with ESC/POS fingerprinting
          - âœ… Direct TCP 9100 printing support for network printers
          - âœ… Improved printer type detection and routing
          - âœ… Network printer manufacturer/model identification
          - âœ… Automatic network discovery (192.168.x.x, 10.0.x.x ranges)
          - âœ… Multi-fallback print routing (TCP â†’ RAW â†’ Bridge)

          **Installation Instructions:**
          1. Download `Beypro-POS-Setup-${{ env.VERSION }}.exe`
          2. Run the installer
          3. Follow the installation wizard (administrator required)
          4. Application launches on completion

          **System Requirements:**
          - Windows 7 SP1 or later
          - .NET Framework 4.5+
          - Minimum 2GB RAM
          - USB or Network ESC/POS printer (optional)
          EOF

          # Create release with retry logic
          RETRY_COUNT=3
          RETRY_DELAY=5
          for ((i=1; i<=RETRY_COUNT; i++)); do
            echo "Attempt $i of $RETRY_COUNT..."
            
            if gh release create "v${{ env.VERSION }}" \
              --title "Beypro POS v${{ env.VERSION }} - Windows Build" \
              --target main \
              --draft=false \
              --prerelease=false \
              --notes-file /tmp/release_notes.md \
              out/*.exe out/*.yml out/*.blockmap 2>&1; then
              echo "âœ… Release created successfully!"
              exit 0
            else
              LAST_EXIT=$?
              echo "âš ï¸ Attempt $i failed with exit code $LAST_EXIT"
              if [ $i -lt $RETRY_COUNT ]; then
                echo "Waiting ${RETRY_DELAY}s before retry..."
                sleep $RETRY_DELAY
              fi
            fi
          done

          echo "âŒ Failed to create release after $RETRY_COUNT attempts"
          exit 1

      - name: Upload artifacts to workflow
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: windows-installer-v${{ env.VERSION }}-node${{ matrix.node-version }}
          path: |
            out/*.exe
            out/*.yml
            out/*.blockmap
          retention-days: 30
          if-no-files-found: warn

      - name: Build Summary
        shell: pwsh
        run: |
          Write-Host "" -ForegroundColor Green
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
          Write-Host "â•‘  âœ… BUILD COMPLETE - Electron v18.0.0  â•‘" -ForegroundColor Green
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
          Write-Host ""
          Write-Host "ğŸ“Š Build Details:" -ForegroundColor Cyan
          Write-Host "  Version: v${{ env.VERSION }}" -ForegroundColor Yellow
          Write-Host "  Node.js: ${{ matrix.node-version }}" -ForegroundColor Yellow
          Write-Host "  Platform: Windows (NSIS)" -ForegroundColor Yellow
          Write-Host "  Status: SUCCESS âœ“" -ForegroundColor Green
          Write-Host ""
          Write-Host "ğŸ“¦ Output Location:" -ForegroundColor Cyan
          Write-Host "  ./out/ - Windows NSIS installer & metadata" -ForegroundColor Yellow
          Write-Host ""
          if (Test-Path "out") {
            Write-Host "ğŸ“¥ Artifacts:" -ForegroundColor Cyan
            Get-ChildItem out -Filter "*.exe" | ForEach-Object {
              Write-Host "  âœ“ $($_.Name)" -ForegroundColor Green
            }
            Get-ChildItem out -Filter "*.yml" | ForEach-Object {
              Write-Host "  âœ“ $($_.Name)" -ForegroundColor Green
            }
          }
          Write-Host ""
          Write-Host "ğŸš€ Next Steps:" -ForegroundColor Cyan
          Write-Host "  1. Download from GitHub Releases" -ForegroundColor Yellow
          Write-Host "  2. Test installation on Windows" -ForegroundColor Yellow
          Write-Host "  3. Verify printer detection works" -ForegroundColor Yellow
          Write-Host "  4. Test print to network printers" -ForegroundColor Yellow
          Write-Host ""

      - name: Notify on failure
        if: failure()
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Red
          Write-Host "â•‘  âŒ BUILD FAILED                   â•‘" -ForegroundColor Red
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Red
          Write-Host ""
          Write-Host "âŒ Build failed. Check logs above for details." -ForegroundColor Red
          Write-Host ""
